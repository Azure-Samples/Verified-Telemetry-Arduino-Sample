
# Getting Started with Verified Telemetry on Arduino

## Table of Contents

* [Verified Telemetry Overview](#verified-telemetry-overview)
* [Links to board specific Device Samples](#sample-setup)
* [Analog and Digital Sensors configuration guide for Verified Telemetry.](#sensor-configuration)
* [Verified Telemetry Concepts](#calibration-and-testing)
* [Verified Telemetry Device Sample](#compatablitity-with-other-boards)

## Verified Telemetry Overview

Verified Telemetry (VT) is a state-of-the-art solution to determine the health of the sensor, i.e., working or faulty, which is consequently used to determine the quality of the sensed data. This is achieved by devising an intelligent “sensor fingerprint”, a set of unique electrical characteristics that differs between working and faulty sensors. The fingerprints can detect faults for a wide variety of off-the-shelf sensors and can be easily implemented with lightweight software code running on the IoT device. VT codebase is described below:

### Verified Telemetry Concepts

A few key concepts of VT are introduced and discussed below:

1. Sensor Fingerprint
    * Sensor fingerprint is an electrical characteristic that is measured by the IoT device for a particular sensor
    * The Sensor fingerprint of a working sensor differs from that of a sensor with fault

1. Sensor Fingerprint Template
    * Sensor fingerprint template is a fingerprint of a working sensor
    * The fingerprint template is collected by the IoT device, ideally when the sensor is provisioned first and stored locally and in the Digital Twin

1. Sensor Fingerprint Collection
    * Sensor Fingerprint Collection is a process where the IoT device measures the fingerprint of a sensor
    * In the device samples, sensor fingerprint is collected at the same frequency at which telemetry is sent by the IoT device

1. Sensor Fingerprint Evaluation
    * A sensor fingerprint that is collected is then compared with the stored sensor fingerprint template
    * If the collected fingerprint matches with the sensor fingerprint template, the sensor is classified as WORKING, otherwise FAULTY

1. Telemetry Status
    * The telemetry status of the telemetry that is generated by the sensor is tagged "true" if the sensor is working and "false" if the sensor has a fault
    * The telemetry status for each telemetry that supports Verified Telemetry feature exists as a non-writable property in the Digital Twin

1. Fingerprint Template Synchronization at Boot
    * If the sensor fingerprint template exists in the Digital Twin, it is fetched and updated on the device when the device boots/resets. This ensures fingerprint template is collected only once when device is provisioned
    * If the sensor fingerprint template does not exist in the Digital Twin, the template on device remains empty after boot and subsequent sensor fingerprint evaluation cannot be performed

| |Description|
|-|-|
|[Verified Telemetry SDK](/Verified-Telemetry) |The SDK which builds on the Arduino middleware and describes how to integrate VT into existing device code. |
|[Verified Telemetry Device Sample](https://github.com/Azure-Samples/Verified-Telemetry-Arduino-Sample) |These Getting Started guides shows device developers how to combine Verified Telemetry with existing Arduino code. |

## Sample Setup

This device sample shows developers how to include Verified Telemetry with you existing Arduino code. This guide is for the ESP8266 based NodeMcu development board, however this sample can also be used to setup other arduino based developement board with minor changes descirbed in [Support for other boards](#compatablitity-with-other-boards):

### Prerequisites

1. ESPRESSIF ESP8266 based NodeMcu board or similar.
    
    The sample is configured to work with ESP8266 based board like the [NodeMcu](https://www.nodemcu.com/index_en.html)

2. Arduino IDE with ESP8266 board support.

    Install the [ESP8266 board support for Arduino](http://arduino.esp8266.com/Arduino/versions/2.0.0/doc/installing.html).

3. Verified Telemetry for Arduino.


    Clone the following repo to download the sample device code, VT Library, and offline versions of the documentation.

  
    ```shell
    git clone https://github.com/Azure-Samples/Verified-Telemetry-Arduino-Sample.git --recursive
    ```

3. Hardware

    > * ESP8266 Board.
    > * USB 2.0 A male to Micro USB male cable
    > * 1 * SPS30 Sensor(Digital Sensor)

## Sensor Configuration

### General Overview

Verified Telemetry for Arduino supports Digital Sensors, to use multiple digital sensors, minimal changes are required to [sample_freertos_verified_telemetry_init.c](sample_freertos_verified_telemetry_init.c) file which are described below.


### Sample configuration for only Digital Sensors

* the sample is configured for 2 Digital sensors, use the below schematic for connections, and the following instructions for changes in the [sample_freertos_verified_telemetry_init.c](sample_freertos_verified_telemetry_init.c) file if required.
* to modify preexisting Hardware Definitions refer [Modifying ADC, GPIO, Hardware Definitions of sample and new sensors](#modifying-adc-gpio-hardware-definitions-of-sample-and-new-sensors).


* ESP8266 Connections 

    * ESP8266 <-> CS Hat Connections
    ![B-L475E-IOT01A Sensor Connections](media/esp_only_cs.png)

    | CS Hat Pin          | NodeMcu Pin | MCU Pin |
    |---------------------|-----------------------------|------------|
    | VCC  |        3V3                   | 3V3(3.3v)                    |
    | GND  |        GND                   | GND                    |
    | SCLK  |        D5                   | GPIO14(SCLK)                    |
    | MISO  |        D6                   | GPIO12(MISO)                    |
    | MOSI  |        D7                   | GPIO13(MOSI)                    |
    | CS  |        SD3                   | GPIO10(SDD3)                    |
    | DIN1  |        3V3                   | 3V3(3.3v)                    |

    * ESP8266 <-> Sensor <-> CS Hat Connections
    ![B-L475E-IOT01A-labeled](media/esp_only_cs_side.jpeg)
    
    | Sensor Name   | Sensor Pin           | NodeMcu/CS Hat Pin | MCU Pin |
    |---------------|----------------------|-----------------------------|------------|
    | Senserion SPS30 | VDD (PIN 1)   |        NodeMcu Vin                   | ESp8266 Vin(5v)                    |
    | Senserion SPS30 | SDA/RX (PIN 2)           | NodeMcu D2                           |  ESp8266 GPIO4(SDA)                  |
    | Senserion SPS30 | SCL/TX (PIN 3)           | NodeMcu D1                           | ESp8266 GPIO5(SCL)        |    
    | Senserion SPS30 | SEL (PIN 4)           | NodeMcu GND                           | ESp8266 GND        |    
    | Senserion SPS30 | GND (PIN 5)           | CS Hat, SENSOR 1 GND                          | CS Hat, SENSOR 1 GND     |    

    

### Modifying ADC, GPIO, Hardware Definitions of sample and new sensors
    
* Hardware Definitions are present in file sample_vt_device_driver.cpp and is externed in sample_vt_device_driver.h, for any new sensor or to modify current hardware, check the instruction below.

* for ESP32 
   
   * got to file [sample_vt_device_driver.c](/sample_vt_device_driver.c) and add/modify Hardware Definitions under ``` /* Sensor Hardware Definitions */ ```
   * got to file [sample_vt_device_driver.h](/sample_vt_device_driver.h) and extern any new/modified Hardware Definitions under ``` /* Sensor Hardware Declaration */ ```

### Adding new sensors to the sample 

* To add new sensors to the sample, the following changes are required in [sample_freertos_verified_telemetry_init.c](sample_freertos_verified_telemetry_init.c).

1. Add new VT_SENSOR_HANDLE & FreeRTOS_VT_OBJECT according to the type of sensor.

   * to add a Digital Sensor, add new VT_SENSOR_HANDLE & FreeRTOS_VT_OBJECT between lines 30 & 35 
         
            #if defined(BOTH_ANALOG_AND_DIGITAL_SENSORS) || defined(ONLY_DIGITAL_SENSORS)
                static FreeRTOS_VT_OBJECT sample_signature_sensor_1;
                static FreeRTOS_VT_OBJECT sample_signature_sensor_2;
                static FreeRTOS_VT_OBJECT sample_signature_sensor_N; // <- replace N with the number of the sensor
                static VT_SENSOR_HANDLE sample_handle_sensor_1;
                static VT_SENSOR_HANDLE sample_handle_sensor_2;
                static VT_SENSOR_HANDLE sample_handle_sensor_N;      // <- replace N with the number of the sensor
            #endif     
            
2. Call init function according to the type of sensor
       
      * to add an Digital Sensor, call vt_digital_sensor_signature_init() between lines 158 & 184 
         
       #if defined(BOTH_ANALOG_AND_DIGITAL_SENSORS) || defined(ONLY_DIGITAL_SENSORS)

           vt_digital_sensor_signature_init(&verified_telemetry_DB,
                                           &sample_signature_sensor_N,
                                           (UCHAR*)"newDigitalSensorN",
                                           true,
                                           vt_adc_id_sensor_N,
                                           (void*)&vt_adc_controller_sensor_N,
                                           (void*)&vt_adc_channel_sensor_N,
                                           CURRENTSENSE_EXTERNAL_ADC_REF_VOLT,
                                           CURRENTSENSE_EXTERNAL_ADC_RESOLUTION,
                                           (1.0f / (CURRENTSENSE_SHUNT_RESISTOR * CURRENTSENSE_OPAMP_GAIN)),
                                           &sample_handle_sensor_N);

       #endif

## Sensor Configuration

In Verified Telemetry, fingerprint collection is a key part of sensor reliablity where a reference fingerprint is collected and used to compare with run-time fingerprints

### First Boot and Calibration 

To give a streamline setup experince, the VT Arduino sample collects a refernce fingerprint when its first booted. for this reason we recommend you to make the sensor connections before running the sample for the first time.

If a re-calibration is required, commands can be sent on serial terminal : resetDigitalSensorOne and resetDigitalSensorTwo

## Support

If you need support, please see our [SUPPORT.md](./SUPPORT.md) file.

## Contributing

This project welcomes contributions and suggestions.  Most contributions require you to agree to a
Contributor License Agreement (CLA) declaring that you have the right to, and actually do, grant us
the rights to use your contribution. For details, visit https://cla.opensource.microsoft.com.

When you submit a pull request, a CLA bot will automatically determine whether you need to provide
a CLA and decorate the PR appropriately (e.g., status check, comment). Simply follow the instructions
provided by the bot. You will only need to do this once across all repos using our CLA.

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/).
For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or
contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.

## License

The Azure Verified Telemetry Getting Started guides are licensed under the [MIT](./LICENSE.txt) license.